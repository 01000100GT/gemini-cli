<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>New Task</title>
    <link rel="stylesheet" href="styles/global.css">
    <link rel="stylesheet" href="styles/chat.css">
    <link rel="stylesheet" href="../../node_modules/highlight.js/styles/github-dark.css">
    <style>
      .spinner {
        border: 2px solid rgba(0, 0, 0, 0.1);
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border-left-color: #09f;
        animation: spin 1s ease infinite;
        display: none; /* Initially hidden */
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .checkmark {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: none; /* Initially hidden */
        stroke-width: 2;
        stroke: #4bb543;
        stroke-miterlimit: 10;
        box-shadow: inset 0px 0px 0px #4bb543;
        animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
      }

      .checkmark__circle {
        stroke-dasharray: 166;
        stroke-dashoffset: 166;
        stroke-width: 2;
        stroke-miterlimit: 10;
        stroke: #4bb543;
        fill: none;
        animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
      }

      .checkmark__check {
        transform-origin: 50% 50%;
        stroke-dasharray: 48;
        stroke-dashoffset: 48;
        animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards;
      }

      @keyframes stroke {
        100% {
          stroke-dashoffset: 0;
        }
      }

      @keyframes scale {
        0%, 100% {
          transform: none;
        }
        50% {
          transform: scale3d(1.1, 1.1, 1);
        }
      }

      @keyframes fill {
        100% {
          box-shadow: inset 0px 0px 0px 30px #4bb543;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-wrapper">
      <div class="chat-header">
        <button id="back-button" class="back-button">â€¹ Dashboard</button>
        <h1 id="chat-title" class="chat-header-title"></h1>
      </div>
      <div id="chat-container" class="chat-container"></div>
      <div class="input-area">
        <div class="input-wrapper">
          <textarea id="message-input" placeholder="Enter your command..." rows="1"></textarea>
          <button id="send-button">Send</button>
          <div id="spinner" class="spinner"></div>
          <svg id="checkmark" class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
          </svg>
        </div>
        <div class="status-bar">
          <div class="status-bar-left">
            <span id="status-cwd"></span>
            <span id="status-branch"></span>
          </div>
          <div class="status-bar-center">
            <span id="status-sandbox"></span>
          </div>
          <div class="status-bar-right">
            <span id="status-model"></span>
            <span id="status-context-window"></span>
          </div>
        </div>
      </div>
    </div>
    <script>
      const { marked } = require('marked');
      const hljs = require('highlight.js');
      const chatContainer = document.getElementById('chat-container');
      const messageInput = document.getElementById('message-input');
      const sendButton = document.getElementById('send-button');
      const chatTitle = document.getElementById('chat-title');
      const spinner = document.getElementById('spinner');
      const checkmark = document.getElementById('checkmark');
      const statusCwd = document.getElementById('status-cwd');
      const statusBranch = document.getElementById('status-branch');
      const statusSandbox = document.getElementById('status-sandbox');
      const statusModel = document.getElementById('status-model');
      const statusContextWindow = document.getElementById('status-context-window');
      let currentTaskId;

      function renderLog(log) {
        chatContainer.innerHTML = '';
        log.forEach(entry => {
          const logEntry = document.createElement('div');
          logEntry.className = 'log-entry';
          const parsedContent = marked(entry.content, {
            highlight: function(code, lang) {
              const language = hljs.getLanguage(lang) ? lang : 'plaintext';
              return hljs.highlight(code, { language }).value;
            }
          });
          logEntry.innerHTML = `
            <div class="log-label">${entry.sender}</div>
            <div class="log-content">${parsedContent}</div>
          `;
          chatContainer.appendChild(logEntry);
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      window.ipcRenderer.on('load-chat', (task) => {
        currentTaskId = task.id;
        chatTitle.textContent = task.title;
        renderLog(task.log);
        window.ipcRenderer.send('get-status-info');
      });

      window.ipcRenderer.on('update-status-info', (info) => {
        statusCwd.textContent = `CWD: ${info.cwd}`;
        statusBranch.textContent = info.branchName ? `(${info.branchName}*)` : '';
        statusSandbox.textContent = `Sandbox: ${info.sandbox ? 'On' : 'Off'}`;
        statusModel.textContent = `Model: ${info.model}`;
        statusContextWindow.textContent = `Context Window: ${info.contextWindow}`;
      });

      window.ipcRenderer.on('thinking', () => {
        spinner.style.display = 'block';
        checkmark.style.display = 'none';
      });

      window.ipcRenderer.on('stream-chunk', ({ chunk }) => {
        const logEntries = chatContainer.getElementsByClassName('log-entry');
        const lastLogEntry = logEntries[logEntries.length - 1];
        const logContent = lastLogEntry.getElementsByClassName('log-content')[0];
        logContent.innerHTML += chunk;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });

      window.ipcRenderer.on('response-received', () => {
        spinner.style.display = 'none';
        checkmark.style.display = 'block';
        setTimeout(() => {
          checkmark.style.display = 'none';
        }, 2000);

        // Re-render the last message as markdown
        const logEntries = chatContainer.getElementsByClassName('log-entry');
        const lastLogEntry = logEntries[logEntries.length - 1];
        const logContent = lastLogEntry.getElementsByClassName('log-content')[0];
        const parsedContent = marked(logContent.innerText, {
          highlight: function(code, lang) {
            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language }).value;
          }
        });
        logContent.innerHTML = parsedContent;
      });

      sendButton.addEventListener('click', () => {
        const message = messageInput.value.trim();
        if (message) {
          window.ipcRenderer.send('send-message', { taskId: currentTaskId, message });
          messageInput.value = '';
        }
      });

      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendButton.click();
        }
      });
      
      document.getElementById('back-button').addEventListener('click', () => {
        window.ipcRenderer.send('navigate-to-dashboard');
      });
    </script>
  </body>
</html>
