{
    # Global options block
    admin off
    log {
        level INFO
    }
}

# Server block listening on the public port
:{$PUBLIC_PORT} {
    # Define a matcher for requests that have the 'repo' query parameter.
    @repo query repo=*

    # When a request matches @repo, rewrite the URI.
    # This uses the explicit Caddy v2 placeholders to reconstruct the URL.
    # It preserves the original path and replaces the query string with
    # 'arg=<value_of_repo_param>', which is what ttyd expects.
    rewrite @repo {http.request.uri.path}?arg={http.request.uri.query.repo}

    # Redirect /vscode to /vscode/ for user convenience.
    @vscode_notslashed path /vscode
    redir @vscode_notslashed /vscode/ 302

    # Handle requests for VS Code, stripping the /vscode prefix before proxying.
    handle_path /vscode/* {
        reverse_proxy localhost:{$CODER_PORT}
    }

    # Handle all other requests by proxying to the ttyd terminal.
    handle {
        reverse_proxy localhost:{$TTYD_PORT}
    }
}